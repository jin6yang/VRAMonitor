<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="VRAMonitor.Views.Pages.ProcessesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:VRAMonitor.Views.Pages"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:VRAMonitor.Models"
    xmlns:viewmodels="using:VRAMonitor.ViewModels.Shared"
    xmlns:helpers="using:VRAMonitor.Helpers"
    mc:Ignorable="d">

    <Page.Resources>
        <CollectionViewSource x:Name="ProcessCVS" IsSourceGrouped="False" />

        <Style x:Key="ProcessItemStyle_NoPill" TargetType="ListViewItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="12,0,12,0"/>
        </Style>

        <Style x:Key="ProcessItemStyle_WithPill" TargetType="ListViewItem" BasedOn="{StaticResource DefaultListViewItemStyle}">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="12,0,12,0"/>
        </Style>

        <Style x:Key="HeaderButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <ContentPresenter x:Name="ContentPresenter"
                                          Content="{TemplateBinding Content}"
                                          ContentTransitions="{TemplateBinding ContentTransitions}"
                                          ContentTemplate="{TemplateBinding ContentTemplate}"
                                          Padding="{TemplateBinding Padding}"
                                          HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                          VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                          AutomationProperties.AccessibilityView="Raw"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <DataTemplate x:Key="ProcessItemTemplate" x:DataType="models:GpuProcess">
            <Grid Padding="0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" MinWidth="200"/>
                    <ColumnDefinition Width="60"/>
                    <ColumnDefinition Width="80"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="150"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <Image Source="{x:Bind Icon, Mode=OneWay}" Width="24" Height="24" Stretch="Uniform"/>
                    <TextBlock Text="{x:Bind Name, Mode=OneWay}" VerticalAlignment="Center" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                </StackPanel>

                <FontIcon Grid.Column="1"
                          x:Uid="Process_EfficiencyIcon"
                          Glyph="&#xEC0A;" 
                          Foreground="ForestGreen" 
                          Visibility="{x:Bind EfficiencyIconVisibility, Mode=OneWay}"
                          HorizontalAlignment="Center" 
                          VerticalAlignment="Center"
                          FontSize="14"/>

                <TextBlock Grid.Column="2" Text="{x:Bind Pid}" VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                <TextBlock Grid.Column="3" Text="{x:Bind VramUsageFormatted, Mode=OneWay}" VerticalAlignment="Center" FontWeight="SemiBold"/>

                <TextBlock Grid.Column="4" Text="{x:Bind GpuEngine, Mode=OneWay}" VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextTrimming="CharacterEllipsis"/>
            </Grid>
        </DataTemplate>
    </Page.Resources>

    <Grid RowDefinitions="Auto, Auto, *, Auto" Margin="20">
        <!-- 顶部标题区 -->
        <StackPanel Grid.Row="0" Margin="0,0,0,10" Spacing="8">
            <TextBlock x:Uid="PageTitle_Processes" Text="Processes" Style="{ThemeResource TitleTextBlockStyle}"/>

            <!-- [核心修改] 使用 ItemsControl 显示多 GPU 状态 -->
            <!-- 绑定到 ViewModel.GpuStatusList，替代旧的 TextBlock -->
            <ItemsControl ItemsSource="{x:Bind ViewModel.GpuStatusList, Mode=OneWay}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:GpuStatusViewModel">
                        <StackPanel Margin="0,0,0,12">
                            <!-- 第一行：显卡名称 [GPU 0] Name (大号字) -->
                            <TextBlock Text="{x:Bind Header}" Style="{ThemeResource SubtitleTextBlockStyle}" />
                            <!-- 第二行：状态详情 (小号字，灰色) -->
                            <TextBlock Text="{x:Bind Details}" 
                                       Style="{ThemeResource BodyStrongTextBlockStyle}" 
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       Margin="0,4,0,0"/>
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>

        <!-- 表头 -->
        <Grid Grid.Row="1" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="12,8" CornerRadius="4,4,0,0" BorderThickness="1,1,1,0" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" MinWidth="200"/>
                <ColumnDefinition Width="60"/>
                <ColumnDefinition Width="80"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="150"/>
            </Grid.ColumnDefinitions>

            <!-- Application Header -->
            <Button Grid.Column="0" Style="{StaticResource HeaderButtonStyle}" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="App">
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock x:Uid="HeaderApp" Text="Application" FontWeight="SemiBold" Opacity="0.8"/>
                    <FontIcon Glyph="{x:Bind ViewModel.GetSortIconGlyph(ViewModel.CurrentSortDirection), Mode=OneWay}" 
                              Visibility="{x:Bind ViewModel.GetSortIconVisibility('App', ViewModel.CurrentSortColumn), Mode=OneWay}"
                              FontSize="10" VerticalAlignment="Center" Opacity="0.8"/>
                </StackPanel>
            </Button>

            <!-- Status Header -->
            <Button Grid.Column="1" Style="{StaticResource HeaderButtonStyle}" HorizontalContentAlignment="Center" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="Status">
                <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                    <TextBlock x:Uid="HeaderStatus" Text="Status" FontWeight="SemiBold" Opacity="0.8"/>
                    <FontIcon Glyph="{x:Bind ViewModel.GetSortIconGlyph(ViewModel.CurrentSortDirection), Mode=OneWay}" 
                              Visibility="{x:Bind ViewModel.GetSortIconVisibility('Status', ViewModel.CurrentSortColumn), Mode=OneWay}"
                              FontSize="10" VerticalAlignment="Center" Opacity="0.8"/>
                </StackPanel>
            </Button>

            <!-- PID Header -->
            <Button Grid.Column="2" Style="{StaticResource HeaderButtonStyle}" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="Pid">
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock x:Uid="HeaderPID" Text="PID" FontWeight="SemiBold" Opacity="0.8"/>
                    <FontIcon Glyph="{x:Bind ViewModel.GetSortIconGlyph(ViewModel.CurrentSortDirection), Mode=OneWay}" 
                              Visibility="{x:Bind ViewModel.GetSortIconVisibility('Pid', ViewModel.CurrentSortColumn), Mode=OneWay}"
                              FontSize="10" VerticalAlignment="Center" Opacity="0.8"/>
                </StackPanel>
            </Button>

            <!-- VRAM Header -->
            <Button Grid.Column="3" Style="{StaticResource HeaderButtonStyle}" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="Vram">
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock x:Uid="HeaderVRAM" Text="VRAM" FontWeight="SemiBold" Opacity="0.8"/>
                    <FontIcon Glyph="{x:Bind ViewModel.GetSortIconGlyph(ViewModel.CurrentSortDirection), Mode=OneWay}" 
                              Visibility="{x:Bind ViewModel.GetSortIconVisibility('Vram', ViewModel.CurrentSortColumn), Mode=OneWay}"
                              FontSize="10" VerticalAlignment="Center" Opacity="0.8"/>
                </StackPanel>
            </Button>

            <!-- Engine Header -->
            <Button Grid.Column="4" Style="{StaticResource HeaderButtonStyle}" Command="{x:Bind ViewModel.SortCommand}" CommandParameter="Engine">
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock x:Uid="HeaderEngine" Text="Engine" FontWeight="SemiBold" Opacity="0.8"/>
                    <FontIcon Glyph="{x:Bind ViewModel.GetSortIconGlyph(ViewModel.CurrentSortDirection), Mode=OneWay}" 
                              Visibility="{x:Bind ViewModel.GetSortIconVisibility('Engine', ViewModel.CurrentSortColumn), Mode=OneWay}"
                              FontSize="10" VerticalAlignment="Center" Opacity="0.8"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- ListView 主体 -->
        <ListView
            x:Name="ProcessListView"
            Grid.Row="2"
            ItemsSource="{x:Bind ProcessCVS.View, Mode=OneWay}"
            SelectedItem="{x:Bind ViewModel.SelectedProcess, Mode=TwoWay}"
            SelectionMode="Single"
            ItemTemplate="{StaticResource ProcessItemTemplate}"
            BorderThickness="1,0,1,1"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            CornerRadius="0,0,4,4">

            <ListView.ItemsPanel>
                <ItemsPanelTemplate>
                    <ItemsStackPanel AreStickyGroupHeadersEnabled="True"/>
                </ItemsPanelTemplate>
            </ListView.ItemsPanel>

            <ListView.GroupStyle>
                <GroupStyle>
                    <GroupStyle.HeaderTemplate>
                        <DataTemplate x:DataType="helpers:GroupInfoList">
                            <Border Background="Transparent" Height="32" Padding="10,0">
                                <TextBlock Text="{x:Bind Key}" Style="{ThemeResource TitleTextBlockStyle}" VerticalAlignment="Center"/>
                            </Border>
                        </DataTemplate>
                    </GroupStyle.HeaderTemplate>
                </GroupStyle>
            </ListView.GroupStyle>

            <ListView.ContextFlyout>
                <MenuFlyout>
                    <ToggleMenuFlyoutItem x:Uid="Menu_GroupBy" 
                                          Text="Group by Name" 
                                          IsChecked="{x:Bind ViewModel.IsGrouped, Mode=OneWay}" 
                                          Command="{x:Bind ViewModel.ToggleGroupingCommand}">
                        <ToggleMenuFlyoutItem.Icon>
                            <FontIcon Glyph="&#xE179;" />
                        </ToggleMenuFlyoutItem.Icon>
                    </ToggleMenuFlyoutItem>

                    <MenuFlyoutSeparator />

                    <MenuFlyoutItem x:Uid="Menu_EndProcess" Text="End Process" Click="OnEndProcessClick">
                        <MenuFlyoutItem.Icon>
                            <FontIcon Glyph="&#xE733;" />
                        </MenuFlyoutItem.Icon>
                    </MenuFlyoutItem>

                    <MenuFlyoutItem x:Uid="Menu_Efficiency" Text="Efficiency Mode" Click="OnEfficiencyModeClick">
                        <MenuFlyoutItem.Icon>
                            <FontIcon Glyph="&#xEC0A;" />
                        </MenuFlyoutItem.Icon>
                    </MenuFlyoutItem>

                    <MenuFlyoutItem x:Uid="Menu_OpenLocation" Text="Open File Location" Click="OnOpenLocationClick">
                        <MenuFlyoutItem.Icon>
                            <FontIcon Glyph="&#xE8DA;" />
                        </MenuFlyoutItem.Icon>
                    </MenuFlyoutItem>

                    <MenuFlyoutItem x:Uid="Menu_Properties" Text="Properties" Click="OnPropertiesClick">
                        <MenuFlyoutItem.Icon>
                            <FontIcon Glyph="&#xF000;" />
                        </MenuFlyoutItem.Icon>
                    </MenuFlyoutItem>
                </MenuFlyout>
            </ListView.ContextFlyout>
        </ListView>

        <!-- 底部状态栏 -->
        <TextBlock Grid.Row="3" Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                   Margin="0,10,0,0" Style="{ThemeResource CaptionTextBlockStyle}"/>
    </Grid>
</Page>